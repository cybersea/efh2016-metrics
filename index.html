<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>EFH Metrics</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!--Remote -->
    <!--
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="http://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    -->
    <link href='css/normalize.css' rel="stylesheet">
    <!--Local -->
    <script src="js/jquery-1.11.2.min.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/turf.min.js"></script>
    <script src="js/jquery.tabletoCSV.js"></script>
    <link rel="stylesheet" href="css/leaflet.css" />

    <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:900" rel="stylesheet">

    <!-- custom css -->
    <link href="css/site.css" rel="stylesheet">

</head>

<body>
    <!-- HTML form for user to select vacancy attribute to map -->
    <!-- Note that values correspond exactly to attribute names in source GeoJSON data file -->

    <div id="right-panel">
        <h2>EFH Proposals</h2>
        <div id="layer-controls">
            <input id="collabLayer" type="checkbox" value="collabLayer" checked>
            <label for="collabLayer" style='color:#E5571D'>Collaborative <button class="layer-select-all">all</button><button class="layer-unselect-all">unsel</button></label>
            <input id="onoLayer" type="checkbox" value="onoLayer" checked>
            <label for="onoLayer" style='color:#6F067B'>Oceana-NRDC-OC <button class="layer-select-all">all</button><button class="layer-unselect-all">unsel</button></label>
            <input id="fmaLayer" type="checkbox" value="fmaLayer" checked>
            <label for="fmaLayer" id="fmaLayer" style='color:#377EB8'>FMA <button class="layer-select-all">all</button><button class="layer-unselect-all">unsel</button></label>
            <input id="gfnmsLayer" type="checkbox" value="gfnmsLayer" checked>
            <label for="gfnmsLayer" style='color:#E2007F'>GFNMS <button class="layer-select-all">all</button><button class="layer-unselect-all">unsel</button></label>
            <input id="greenpeaceLayer" type="checkbox" value="greenpeaceLayer" checked>
            <label for="greenpeaceLayer" style='color:#0F6001'>Greenpeace <button class="layer-select-all">all</button><button class="layer-unselect-all">unsel</button></label>
            <input id="mbnmsLayer" type="checkbox" value="mbnmsLayer" checked>
            <label for="mbnmsLayer" style='color:#E9BD02'>MBNMS <button class="layer-select-all">all</button><button class="layer-unselect-all">unsel</button></label>
            <input id="mciLayer" type="checkbox" value="mciLayer" checked>
            <label for="mciLayer" style='color:#650B0B'>MCI <button class="layer-select-all">all</button><button class="layer-unselect-all">unsel</button></label>
            <input id="noneLayer" type="checkbox" value="noneLayer" checked>
            <label for="noneLayer" style='color:#0F97A3'>None <button class="layer-select-all">all</button><button class="layer-unselect-all">unsel</button></label>
        </div>

        <div id='ui-controls'>
            <button value="Zoom" id="zoom">Zoom to Selection</button>
            <button value="Clear" id="clear">Clear all Selections</button>
        </div>


    </div>
    <!-- end right-panel -->

    <div id='map'></div>

    <!-- Side panel Div   -->
    <div id='side-panel'>
        <h1>West Coast Groundfish<br> Essential Fish Habitat</h1>
        <h2 class='side-panel-header'>Alternatives Analysis Metrics</h2>
        <div id='panel-tabs'>
            <button class='selected' value='summary-panel'>Summary</button>
            <button value='polygons-panel'>Polygons <span id="poly-count">(0)</span></button>
            <button value='info-panel'>Info</button>
        </div>
        <div class='side-panel' id='summary-panel'>
            <!-- <h3 id='poly-count'></h3> -->
            <div class="table-wrapper"><table id="summary-metrics"></table></div>
            <span class='start-text'>
                <p>Click on individual proposal polygons to add or remove them from the selection</p>
                <p>A summary of metrics for all selected polygons will display here.</p>
            </span>
        </div>
        <div class='side-panel' id='polygons-panel'>
            <div class="table-wrapper"><table id="polygon-metrics" class="data"></table></div>
            <button id='download-csv'>Download CSV File</button>
            <span class='start-text'>
                <p>Click on individual proposal polygons to add or remove them from the selection</p>
                <p>A table listing all the selected polygons and their metrics will display here.</p>
            </span>
        </div>
        <div class='side-panel' id='info-panel'>
            <h2>Background</h2>
        <p>The <a href="http://www.pcouncil.org/" target="_blank">Pacific Fishery Managment Council</a> (Council) is currently reviewing <a href="http://www.pcouncil.org/groundfish/groundfish-essential-fish-habitat/" target="_blank">Groundfish Essential Fish Habitat</a> Conservation Areas (EFHCA) off the West Coast of the United States.  The Council is evaluating proposals that include areas to be closed to commercial trawl fishing, as well as closed areas to be reopened.</p>
        <p>During this review, the Council will consider the importance of the habitat to groundfish (i.e., rockfish, flatfish) and other environmental considerations, as well as the economic impacts and benefits to the fishing and associated businesses and communities. </p>

        <h2>How to Use this Tool</h2>
        <p>This tool allows a user, such as a Council Member, to select a custom set of EFH proposal polygons and see a summary of the metrics for their set. </p>
        <p>
            <li>Click a polygon to add or remove it from the selection</li>
            <li>Hover over a polygon to view its metrics</li>
            <li>Toggle a proposal name in the right panel to draw or remove its polygons from the map</li>
            <li>View summary metrics for all selected polygons in the Summary Tab</li>
            <li>View and download a table of individual metrics for selected polygons in the Polygons Tab</li>
        </p>
        <p>Note: To avoid double-counting in the summary metrics, if you select a polygon that overlaps a current selection, the overlapping polygon will be removed from the selection.</p>
            
        <h2>Credits</h2>
        <p>NOAA, National Marine Fisheries Service (NMFS) scientists and colleagues laid the analytical groundwork for this review through  a multi-year synthesis of new data sets and analyses.  Results of the Groundfish Essential Fish Habitat (EFH) Synthesis are available through the <a href="http://efh-catalog.coas.oregonstate.edu/synthesis/" target="_blank">EFH Catalog</a>. </p>
        <p>Web Development by Allison Bailey, <a href="http://www.soundgis.com" target="_blank">Sound GIS</a></p>
        </div>
    </div>


    <!--  GeoJSON source data (var proposals_metrics)   -->
    <script src="data/efh_proposals_metrics.js"></script>

    <!--  Main mapping script   -->
    <script>
        // instantiate the Leaflet map
        var options = {
            center: [41, -121.2],
            zoom: 6,
            dragging: true,
            zoomControl: true
        }
        var map = L.map('map', options);

        // Base Map
        var esri_ocean = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
            maxZoom: 11
        });
        esri_ocean.addTo(map);

        L.control.scale().addTo(map); // Add scale bar

        // Create Info Box for display of feature data on hover
        drawInfo();

        // Call function to create user interface for interacting with selected set
        buildUI();

        // Create a blank table for summary metrics
//        buildSummary();

        // Create blank table for individual polygon metrics
//        buildPolyTable();

        // Style info for individual proposal layers
        var layerInfo = {
                collabLayer: {
                    proposer: "Collaborative",
                    color: "#E5571D"
                },
                onoLayer: {
                    proposer: "Oceana-NRDC-OC",
                    color: "#6F067B"
                },
                fmaLayer: {
                    proposer: "FMA",
                    color: "#377EB8"
                },
                gfnmsLayer: {
                    proposer: "GFNMS",
                    color: "#E2007F"

                },
                greenpeaceLayer: {
                    proposer: "Greenpeace",
                    color: "#0F6001"
                },
                mbnmsLayer: {
                    proposer: "MBNMS",
                    color: "#E9BD02"
                },
                mciLayer: {
                    proposer: "MCI",
                    color: "#650B0B"
                },
                noneLayer: {
                    proposer: "None",
                    color: "#0F97A3",
                    //color: "#0D8792",
                    //color: "#228E9C",
                    //color: "#0B7983",
                },            
            }
            //


        var geoJsonLayers = {}; // global to store all the geoJSON layers
        var selectedSet = []; // array to store selected features
        var selectedSetObj = {}; // object for selected features

        // Create individual geoJson Layers for each proposal
        for (var lyr in layerInfo) {

            geoJsonLayers[lyr] = L.geoJson(proposals_metrics, {
                filter: function (feature) {
                    if (feature.properties.Proposer == [layerInfo[lyr].proposer]) {
                        return feature;
                    }
                },
                style: function (feature) {
                    var opcty;
                    if (feature.properties.RegAction == "reopen")
                        opcty = 0.1;
                    else if (feature.properties.RegAction == "close")
                        opcty = 0.4;
                    styles = {
                        color: layerInfo[lyr].color,
                        fillColor: layerInfo[lyr].color,
                        fill: true,
                        weight: 2,
                        fillOpacity: opcty
                    }
                    return styles
                },
                onEachFeature: function (feature, layer) {
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: resetHighlight,
                        click: function(e){
                            toggleSelected(e.target);
                            //selected(e.target);
                        },
                    });
                }
            }).addTo(map);

            geoJsonLayers[lyr].startStyle = styles

        } // end of loop through all geoJSON layers


        // Select or unselect feature depending on its current state
        function toggleSelected(layer){

            var id = layer.feature.properties.concat_id;

            if (isSelected(layer, id) < 0) {// not in selected set
                
                // select it
                selected(layer);
                
            } else { // If already in selected set

                // Unselect it
                unselected(layer);

            }           
        } // end toggleSelected()
        
 
        // Runs when a feature is selected
        function selected(layer) {

            var data = layer.feature.properties;
            var id = layer.feature.properties.concat_id;
            var overlapping = [];

            // If it isn't already selected, add to set and change style
            //  otherwise, unselect it

            // Change Styles 
            layer.setStyle({
                color: "yellow",
            });
            layer.bringToFront();

            // Test if it overlaps any current selections
            for (var i = 0; i < selectedSet.length; i++) {
                var feat2compare = selectedSet[i]
                if (isOverlapped(layer, feat2compare)) {
                    // if a current feature is overlapped by selection
                    //  add to list 
                    overlapping.push(feat2compare);
                }
            }

            // Add selected feature to the selected set
            selectedSet.push(layer);

            // Add the feature's stats to the summary statistics
            updateSummmary();

            // Add the feature's metrics to the polygon table
            updatePolyTable(data);

            // Unselect any overlapping features
            overlapping.forEach(function (layer) {
                unselected(layer);
            });
            
        } // end selected()

        // Runs when a feature is removed from selection 
        function unselected(layer) {

            // var layer = e.target;
            var data = layer.feature.properties;
            var id = layer.feature.properties.concat_id;
            var proposer = layer.feature.properties.Proposer;

            // If it is selected, remove from selected set array and revert style
            //  otherwise, do nothing
            var idx = isSelected(layer, id)

            if (idx >= 0) {

                // Remove poly from selected set
                selectedSet.splice(idx, 1);

                // Get original color of layer based on proposer
                for (lyr in layerInfo) {
                    if (proposer === layerInfo[lyr].proposer) {
                        var strokeColor = layerInfo[lyr].color
                    }
                }

                // Change color back to original 
                layer.setStyle({
                    color: strokeColor,
                });
                layer.bringToFront();
            }

            // Remove the feature's stats from the summary statistics
            updateSummmary();

        } // end unselected()

        // Check if a feature is part of the selected set
        function isSelected(layer, id) {
            var idx = -1;
            for (var i = 0; i < selectedSet.length; i++) {
                if (selectedSet[i].feature.properties.concat_id === id) {
                    // Get the array index of the object if it exists
                    idx = i;
                    break;
                }
            }
            return idx
        } // end isSelected()

        // Determine if two polygons overlap
        function isOverlapped(feature1, feature2) {

            // Input is two Leaflet layer polygons 
            // Convert polys GeoJSON
            var poly1 = feature1.toGeoJSON();
            var poly2 = feature2.toGeoJSON();

            // Turf Intersection function
            var intersection = turf.intersect(poly1, poly2);

            // Only want poly overlaps, not shared boundary intersections
            if (intersection) {
                if (intersection.geometry.type === "Polygon") {
                    return feature2;
                } else {
                    return false
                }
            } else {
                return false
            }

        } // end isOverlapped()

        // Create an array of Leaflet Bounds for each feature
        function getSelectedBounds() {

            var selectedBounds = [];

            // Get bounds for selected set of layers
            for (i = 0; i < selectedSet.length; i++) {
                selectedBounds.push(selectedSet[i].getBounds())
            }

            return selectedBounds;

        } // end getSelectedBounds()

        function zoomToSelected() {

            // Get the bounds of currently selected features
            var bounds = getSelectedBounds();

            // Zooms to currently selected polygons
            map.fitBounds(getSelectedBounds());

        } // end zoomToSelected()


        // Clear all selected polygons
        function clearSelected() {

            for (var i = 0; i < selectedSet.length; i++) {

                var layer = selectedSet[i];
                var proposer = layer.feature.properties.Proposer;

                // Get original color of layer based on proposer
                for (lyr in layerInfo) {
                    if (proposer === layerInfo[lyr].proposer) {
                        var strokeColor = layerInfo[lyr].color
                    }
                }

                // Change color back to original 
                layer.setStyle({
                    color: strokeColor,
                });

                $('#zoom').removeClass('available');
                $('#clear').removeClass('available');
            }

            selectedSet = []; // remove all layers from selected set

            buildSummary() // re-create empty summary table

            buildPolyTable() // re-create empty polygon table
        }

        // Runs on mouseover of a feature - updates style and grabs data for info box
        function highlightFeature(e) {

            var layer = e.target;

            // Change Styles to make outline wider
            layer.setStyle({
                weight: 5,
                dashArray: '',
            });

            if (!L.Browser.ie && !L.Browser.opera) {
                layer.bringToFront();
            }

            // Update the info box               
            updateInfo(layer)

            $(".poly-info").show(); // Show the info box

        } // end highlightFeature()

        // Runs when mouseout of feature - Returns feature style to original
        function resetHighlight(e) {

            // Function that when mouseout of feature
            var layer = e.target;

            layer.setStyle({
                weight: 2
            })

            $(".poly-info").hide(); // Hide the info box

        } // end resetHighlight()

        function drawInfo() {

            // create a new Leaflet control object, and position it lower right
            var info = L.control({
                position: 'bottomright'
            });
            info.onAdd = function (map) { // when info control is added to map
                    // Create a div to hold the info box with a class name of "info"
                    var div = L.DomUtil.create('div', 'poly-info');
                    // return empty div to be added to map
                    return div;
                }
                // Add empty info div to map
            info.addTo(map);
            $(".poly-info").hide(); // hide empty info box until populated

        } // end drawInfo()


        function updateInfo(layer) {

            // variable to access layer properties
            var data = layer.feature.properties;

            // populate html variable with header - Site name
            // and values for the specified attributes using the 
            // layer (feature) that was passed to this function
            var html = "<h3>" + data.SiteName + "</h3>" // +
            html += "<br>" + "<b>Action: </b>" + data.RegAction;
            html += "<br>" + "<b>Proposer: </b>" + data.Proposer;
            html += "<br>" + "<b>Area (sq mi): </b>" + sqm2sqmi(data.SiteAreaM2);
            html += "<br>" + "<b>Hard Substrate: </b>" + pct(data.hard, data.SiteAreaM2);
            html += "<br>" + "<b>Mixed Substrate: </b>" + pct(data.mixed, data.SiteAreaM2);
            html += "<br>" + "<b>Soft Substrate: </b>" + pct(data.soft, data.SiteAreaM2);
            html += "<br>" + "<b>Unknown Substrate: </b>" + pct(data.unknown, data.SiteAreaM2);
            html += "<br>" + "<b>Canyons & Gullys: </b>" + pct(data.CynAreaM2, data.SiteAreaM2);
            html += "<br>" + "<b>Seamounts: </b>" + pct(data.SmtAreaM2, data.SiteAreaM2);
            html += "<br>" + "<b>Corals & Sponges</b> (1x1 km blocks): " + data.corspg_cnt;
            html += "<br>" + "<b>Highest 20% Overfished Predicted Spp: </b> " + pct(data.OF20AreaM2, data.SiteAreaM2);

            if (data.VesCount >= 3 || data.VesCount == 0) {
                html += "<br>" + "<b>Trawl Tow Length (mi): </b>" + m2mi(data.TowLenM);
                html += "<br>" + "<b>Total Catch (MT): </b> " + rnd(data.Total_MT,1);
                html += "<br>" + "<b>Total Ex-Vessel Value: </b> " + dollars(data.Total_Rev);
            } else {
                html += "<br>" + "<b>Trawl Tow Length: </b> **";
                html += "<br>" + "<b>Total Catch (MT): </b> **";
                html += "<br>" + "<b>Total Ex-Vessel Value: </b> **";
            }     

            // Assign the html content to the info box using JQuery selector
            $(".poly-info").html(html);

        } // end updateInfo()

        function buildUI() {
            // Perform following actions When the DOM object with id of "selPolys" is changed
            // i.e., the user selects an option from the HTML form
            $('#ui-controls button').click(function () {
                // Set attribute to user selection from pull-down menu
                attribute = $(this).val();
                // Re-draw map with new attribute
                if (attribute === "Zoom" && selectedSet.length > 0) {
                    zoomToSelected();
                }
                if (attribute === "Clear") {
                    clearSelected();
                }

            });

            $('#layer-controls input').change(function () {

                var targetLayer = $(this).val();
                if (this.checked) {
                    map.addLayer(geoJsonLayers[targetLayer]);
                } else {
                    map.removeLayer(geoJsonLayers[targetLayer]);
                }

            });
            
            $('.layer-select-all').on('click', function () {
                var targetLayer = $(this).parent().attr('for');
                               
                geoJsonLayers[targetLayer].eachLayer(function(f){
                   selected(f); 
                                                     
                });
                               
            });
            
            $('.layer-unselect-all').on('click', function () {
                var targetLayer = $(this).parent().attr('for');
                               
                geoJsonLayers[targetLayer].eachLayer(function(f){
                   unselected(f); 
                                                     
                });
                               
            });
            

            $('#panel-tabs button').on('click', function () {
                
                // Updates when one of the tabs on the left panel is clicked
                var elem = $(this); // the button that was clicked
                var id = $(this).val(); // the button value  = the id of for the panel content
                // Change clicked item to selected
                elem.addClass('selected');
                // Unselect other buttons
                elem.siblings().removeClass('selected');
                // Hide content from unselected tabs
                elem.siblings().each(function () {
                        var sib_id = $(this).val()
                        $('#'.concat(sib_id)).hide();
                    })
                    // Show content from selected tab
                $('#'.concat(id)).show();
            });
        }

        // Convert sq meters to square miles and format nicely
        function sqm2sqmi(val) {
            return (val / 2589988.11).toLocaleString(undefined, {
                maximumFractionDigits: 0
            })
        }

        // Convert meters to miles and format nicely
        function m2mi(val) {
            return (val / 1609.344).toLocaleString(undefined, {
                maximumFractionDigits: 0
            })
        }

        // Calculate percentage or return zero if denominator is zero
        function pct(num, denom) {
            if (denom == 0 || !(num)) {
                return "0%";
            } else {
                return (num / denom).toLocaleString(undefined, {
                    style: 'percent'
                });
            }
        }
        
        // Round and Format to specified number of decimals
        function rnd(val, digits){
            return val.toLocaleString(undefined, {
                maximumFractionDigits: digits,
                minimumFractionDigits: digits,
            })
        }
        
        // Round to even thousands of dollars
        function dollars(val){
            return val.toLocaleString(undefined, {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }) + "K"
        }

        function buildSummary() {

            // Remove starter text
            $('.start-text').hide();
            
            // Header for Polygon count
            $('#poly-count').text("(0)");

            // shortcut to our table element
            var $table = $('#summary-metrics'),
                rows = '';

            // Create empty table structure
            rows += '<tr class="table-row-header"><th>Environmental Metrics</th>' + '<th>Close</th>' + '<th>Open</th>' + '<th>Net</th></tr>' +
                '<tr><td>Area (sq mi)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Physical Habitat</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Hard</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Mixed</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Soft</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Unknown</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Priority Habitats</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Hard Substrate</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Canyons & Gullies</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Seamounts</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Corals & Sponges (1 km blocks)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Highest 20% Predicted Spp Occurrence</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr class="table-row-header"><th>Socioeconomic Metrics</th>' + '<th>Displace</th>' + '<th>Restore</th>' + '<th>Net</th></tr>' +
                '<tr><td>Total Tow Length (mi)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Total Catch (Metric Tons)</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Flatfish (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Rockfish (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Roundfish (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Sharks & Skates (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Other (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Total Ex-Vessel Value (Thousands of $)</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Flatfish ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Rockfish ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Roundfish ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Sharks & Skates ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Other ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>';
                    
            // update the html of the table
            $table.html(rows);

        }

        function updateSummmary() {
            // use selectedSet to summarize Data

            // List of metric attributes
            var metric_attributes = [
                "SiteAreaM2",
                "hard",
                "mixed",
                "soft",
                "unknown",
                "CynAreaM2",
                "SmtAreaM2",
                "corspg_cnt",
                "OF20AreaM2",
                "TowLenM",
                "Total_MT",
                "Flatfish_MT",
                "Rockfish_MT",
                "Roundfish_MT",
                "SharkSkate_MT",
                "Other_MT",
                "Total_Rev",
                "Flatfish_Rev",
                "Rockfish_Rev",
                "Roundfish_Rev",
                "SharkSkate_Rev",
                "Other_Rev",               
            ]


            var polyData = []; // individual polygon attributes

            // Initialize Summary Data objects with zeros for all metrics
            var summOpen = {
                SiteAreaM2: 0,
                hard: 0,
                mixed: 0,
                soft: 0,
                unknown: 0,
                CynAreaM2: 0,
                SmtAreaM2: 0,
                corspg_cnt: 0,
                OF20AreaM2: 0,
                TowLenM: 0,
                Total_MT: 0,
                Flatfish_MT: 0,
                Rockfish_MT: 0,
                Roundfish_MT: 0,
                SharkSkate_MT: 0,
                Other_MT: 0,
                Total_Rev: 0,
                Flatfish_Rev: 0,
                Rockfish_Rev: 0,
                Roundfish_Rev: 0,
                SharkSkate_Rev: 0,
                Other_Rev: 0    
            };
            var summClose = {
                SiteAreaM2: 0,
                hard: 0,
                mixed: 0,
                soft: 0,
                unknown: 0,
                CynAreaM2: 0,
                SmtAreaM2: 0,
                corspg_cnt: 0,
                TowLenM: 0,
                OF20AreaM2: 0,
                TowLenM: 0,
                Total_MT: 0,
                Flatfish_MT: 0,
                Rockfish_MT: 0,
                Roundfish_MT: 0,
                SharkSkate_MT: 0,
                Other_MT: 0,
                Total_Rev: 0,
                Flatfish_Rev: 0,
                Rockfish_Rev: 0,
                Roundfish_Rev: 0,
                SharkSkate_Rev: 0,
                Other_Rev: 0    
            };

            // loop through all the selected features
            selectedSet.forEach(function (selection) {

                var props = selection.feature.properties;

                // Add individual polygon metrics to polyData list
                polyData.push(props);

                // loop through the properties
                for (var att in props) {

                    // Only use metrics of interest
                    if (metric_attributes.indexOf(att) >= 0) {
                        // if it's a number
                        if (Number(props[att])) {

                            // Areas to be closed
                            if (props.RegAction === "close") {
                                summClose[att] += props[att];
                            } else { // areas to be reopened
                                summOpen[att] += props[att];
                            }

                        }
                    }
                }

            }); // end of forEach loop through selectedSet            

            // create Net value object
            summNet = calcNet(summClose, summOpen);

            // Update area count text
            var polyCount = selectedSet.length;

            // Activate or de-activate zoom and clear buttons depending on presence of selection
            if (polyCount == 0) {
                $('#zoom').removeClass('available');
                $('#clear').removeClass('available');
            } else {
                $('#zoom').addClass('available');
                $('#clear').addClass('available');
            }


            if (polyCount == 1) {
                $('#poly-count').text("(" + polyCount + ")")
            } else {
                $('#poly-count').text("(" + polyCount + ")")
            }

            // Remove starter text
            $('.start-text').hide();
            
            // shortcut to our table element
            var $table = $('#summary-metrics'),
                rows = '';

            // Variables for frequently used metrics
            var areaClose = summClose.SiteAreaM2;
            var areaOpen = summOpen.SiteAreaM2;
            var areaNet = areaClose - areaOpen;

            // Populate the table
            rows += '<tr class="table-row-header"><th>Environmental Metrics</th>' + '<th>Close</th>' + '<th>Open</th>' + '<th>Net</th></tr>' +
                '<tr><td>Area (sq mi)</td>' + '<td>' + sqm2sqmi(areaClose) + '</td>' +
                '<td>' + sqm2sqmi(areaOpen) + '</td>' +
                '<td>' + sqm2sqmi(areaNet) + '</td></tr>' +
                '<tr><th>Physical Habitat</th><td></td><td></td><td></td></tr>' +
                '<tr><td>Hard</td>' + '<td>' + pct(summClose.hard, areaClose) + '</td>' +
                '<td>' + pct(summOpen.hard, areaOpen) + '</td>' +
                '<td>' + pct(calcNet(summClose.hard, summOpen.hard), areaNet) + '</td></tr>' +
                '<tr><td>Mixed</td>' + '<td>' + pct(summClose.mixed, areaClose) + '</td>' +
                '<td>' + pct(summOpen.mixed, areaOpen) + '</td>' +
                '<td>' + pct(calcNet(summClose.mixed, summOpen.mixed), areaNet) + '</td></tr>' +
                '<tr><td>Soft</td>' + '<td>' + pct(summClose.soft, areaClose) + '</td>' +
                '<td>' + pct(summOpen.soft, areaOpen) + '</td>' +
                '<td>' + pct(calcNet(summClose.soft, summOpen.soft), areaNet) + '</td></tr>' +
                '<tr><td>Unknown</td>' + '<td>' + pct(summClose.unknown, areaClose) + '</td>' +
                '<td>' + pct(summOpen.unknown, areaOpen) + '</td>' +
                '<td>' + pct(calcNet(summClose.unknown, summOpen.unknown), areaNet) + '</td></tr>' +
                '<tr><th>Priority Habitats</th><td></td><td></td><td></td></tr>' +
                '<tr><td>Hard Substrate</td>' + '<td>' + pct(summClose.hard, areaClose) + '</td>' +
                '<td>' + pct(summOpen.hard, areaOpen) + '</td>' +
                '<td>' + pct(calcNet(summClose.hard, summOpen.hard), areaNet) + '</td></tr>' +
                '<tr><td>Canyons & Gullies</td>' + '<td>' + pct(summClose.CynAreaM2, areaClose) + '</td>' +
                '<td>' + pct(summOpen.CynAreaM2, areaOpen) + '</td>' +
                '<td>' + pct(calcNet(summClose.CynAreaM2, summOpen.CynAreaM2), areaNet) + '</td></tr>' +
                '<tr><td>Seamounts</td>' + '<td>' + pct(summClose.SmtAreaM2, areaClose) + '</td>' +
                '<td>' + pct(summOpen.SmtAreaM2, areaOpen) + '</td>' +
                '<td>' + pct(calcNet(summClose.SmtAreaM2, summOpen.SmtAreaM2), areaNet) + '</td></tr>' +
                '<tr><td>Corals & Sponges (1 km blocks)</td>' + '<td>' + summClose.corspg_cnt + '</td>' +
                '<td>' + summOpen.corspg_cnt + '</td>' +
                '<td>' + calcNet(summClose.corspg_cnt, summOpen.corspg_cnt) + '</td></tr>' +
                '<tr><td>Highest 20% Predicted Spp Occurrence</td>' + '<td>' + pct(summClose.OF20AreaM2, areaClose) + '</td>' +
                '<td>' + pct(summOpen.OF20AreaM2, areaOpen) + '</td>' +
                '<td>' + pct(calcNet(summClose.OF20AreaM2, summOpen.OF20AreaM2), areaNet) + '</td></tr>' +
                '<tr class="table-row-header"><th>Socioeconomic Metrics</th><th>Displace</th><th>Restore</th><th>Net</th></tr>' +
                '<tr><td>Total Tow Length (mi)</td>' + '<td>' + m2mi(summClose.TowLenM) + '</td>' +
                '<td>' + m2mi(summOpen.TowLenM) + '</td>' +
                '<td>' + m2mi(calcNet(summClose.TowLenM, summOpen.TowLenM)) + '</td></tr>' +
                '<tr><th>Total Catch (Metric Tons)</th>' + '<td>' + rnd(summClose.Total_MT, 1) + '</td>' + 
                '<td>' + rnd(summOpen.Total_MT, 1) + '</td>' + 
                '<td>' + rnd(calcNet(summClose.Total_MT,summOpen.Total_MT), 1) + '</td></tr>' +
                '<tr><td>Flatfish (MT)</td>' + '<td>' + rnd(summClose.Flatfish_MT, 1) + '</td>' + 
                '<td>' + rnd(summOpen.Flatfish_MT, 1) + '</td>' + 
                '<td>' + rnd(calcNet(summClose.Flatfish_MT,summOpen.Flatfish_MT), 1) + '</td></tr>' +
                '<tr><td>Rockfish (MT)</td>'  + '<td>' + rnd(summClose.Rockfish_MT, 1) + '</td>' + 
                '<td>' + rnd(summOpen.Rockfish_MT, 1) + '</td>' + 
                '<td>' + rnd(calcNet(summClose.Rockfish_MT,summOpen.Rockfish_MT), 1) + '</td></tr>' +
                '<tr><td>Roundfish (MT)</td>'  + '<td>' + rnd(summClose.Roundfish_MT, 1) + '</td>' + 
                '<td>' + rnd(summOpen.Roundfish_MT, 1) + '</td>' + 
                '<td>' + rnd(calcNet(summClose.Roundfish_MT,summOpen.Roundfish_MT), 1) + '</td></tr>' +
                '<tr><td>Sharks & Skates (MT)</td>'  + '<td>' + rnd(summClose.SharkSkate_MT, 1) + '</td>' + 
                '<td>' + rnd(summOpen.SharkSkate_MT, 1) + '</td>' + 
                '<td>' + rnd(calcNet(summClose.SharkSkate_MT,summOpen.SharkSkate_MT), 1) + '</td></tr>' +
                '<tr><td>Other (MT)</td>' + '<td>' + rnd(summClose.Other_MT, 1) + '</td>' + 
                '<td>' + rnd(summOpen.Other_MT, 1) + '</td>' + 
                '<td>' + rnd(calcNet(summClose.Other_MT,summOpen.Other_MT), 1) + '</td></tr>' +
                '<tr><th>Total Ex-Vessel Value (Thousands of $)</th>' + '<td>' + dollars(summClose.Total_Rev) + '</td>' + 
                '<td>' + dollars(summOpen.Total_Rev) + '</td>' + 
                '<td>' + dollars(calcNet(summClose.Total_Rev,summOpen.Total_Rev)) + '</td></tr>' +
                '<tr><td>Flatfish ($1K)</td>' + '<td>' + dollars(summClose.Flatfish_Rev) + '</td>' + 
                '<td>' + dollars(summOpen.Flatfish_Rev) + '</td>' + 
                '<td>' + dollars(calcNet(summClose.Flatfish_Rev,summOpen.Flatfish_Rev)) + '</td></tr>' +
                '<tr><td>Rockfish ($1K)</td>'  + '<td>' + dollars(summClose.Rockfish_Rev) + '</td>' + 
                '<td>' + dollars(summOpen.Rockfish_Rev) + '</td>' + 
                '<td>' + dollars(calcNet(summClose.Rockfish_Rev,summOpen.Rockfish_Rev)) + '</td></tr>' +
                '<tr><td>Roundfish ($1K)</td>'  + '<td>' + dollars(summClose.Roundfish_Rev) + '</td>' + 
                '<td>' + dollars(summOpen.Roundfish_Rev) + '</td>' + 
                '<td>' + dollars(calcNet(summClose.Roundfish_Rev,summOpen.Roundfish_Rev)) + '</td></tr>' +
                '<tr><td>Sharks & Skates ($1K)</td>'  + '<td>' + dollars(summClose.SharkSkate_Rev) + '</td>' + 
                '<td>' + dollars(summOpen.SharkSkate_Rev) + '</td>' + 
                '<td>' + dollars(calcNet(summClose.SharkSkate_Rev,summOpen.SharkSkate_Rev)) + '</td></tr>' +
                '<tr><td>Other ($1K)</td>' + '<td>' + dollars(summClose.Other_Rev) + '</td>' + 
                '<td>' + dollars(summOpen.Other_Rev) + '</td>' + 
                '<td>' + dollars(calcNet(summClose.Other_Rev,summOpen.Other_Rev)) + '</td></tr>';
            
            // update the html of the table
            $table.html(rows);

            // update individual poly table with the selected set
            updatePolyTable();


        } // end updatedSummary()

        function calcNet(close, open) {

            // Calculate Net value from summary data values
            // Most values are just difference, but some, like Coral/Sponge block count will need additional logic
            return close - open;

        } // end calcNet

        function buildPolyTable() {
            // shortcut to our table element
            var $table = $('#polygon-metrics'),
                rows = '';

            // empty table structure
//            rows += '<tr>' +
//                '<th colspan="3">Site</th>' +
//                '<th colspan="5">Physical Habitat </th>' +
//                '<th colspan="4">Priority Habitats</th>' +
//                '<th>Trawl Activity</th>' +
//                '</tr>'
            rows += '<tr>' +
                '<th>Action</th>' +
                '<th>Site Name</th>' +
                '<th>Proposer</th>' +
                '<th>Area (sq mi)</th>' +
                '<th>Hard</th>' +
                '<th>Mixed</th>' +
                '<th>Soft</th>' +
                '<th>Unknown</th>' +
                '<th>Canyons & Gullies</th>' +
                '<th>Seamounts</th>' +
                '<th>Corals & Sponges (1 km blocks)</th>' +
                '<th>Highest 20% Predicted OF Spp</th>' +
                '<th>Trawl Tow Length (mi)</th>' +
                '<th>Total Catch (MT)</th>' +
                '<th>Flatfish Catch (MT)</th>' +
                '<th>Rockfish Catch (MT)</th>' +
                '<th>Roundfish Catch (MT)</th>' +
                '<th>Sharks & Skates Catch (MT)</th>' +
                '<th>Other Catch (MT)</th>' +
                '<th>Total Ex-Vessel Value</th>' +
                '<th>Flatfish Ex-Vessel Value</th>' +
                '<th>Rockfish Ex-Vessel Value</th>' +
                '<th>Roundfish Ex-Vessel Value</th>' +
                '<th>Sharks & Skates Ex-Vessel Value</th>' +
                '<th>Other Catch Ex-Vessel Value</th>' +                
                '</tr>'

            // update the html of the table
            $table.html(rows);
            
            //  Hide the csv download button
            $('#download-csv').removeClass('show');

        }

        function updatePolyTable() {
            // Build content of Poly Table with selectedSet

            var $table = $('#polygon-metrics'),
                rows = '';

            // Table Headers
//            rows += '<tr>' +
//                '<th colspan="3">Site</th>' +
//                '<th colspan="5">Physical Habitat </th>' +
//                '<th colspan="4">Priority Habitats</th>' +
//                '<th>Trawl Activity</th>' +
//                '</tr>'
           rows += '<tr>' +
                '<th>Action</th>' +
                '<th>Name</th>' +
                '<th>Proposer</th>' +
                '<th>Area (sq mi)</th>' +
                '<th>Hard</th>' +
                '<th>Mixed</th>' +
                '<th>Soft</th>' +
                '<th>Unknown</th>' +
                '<th>Canyons and Gullies</th>' +
                '<th>Seamounts</th>' +
                '<th>Corals & Sponges (1 km blocks)</th>' +
                '<th>Highest 20% Predicted OF Spp</th>' +
                '<th>Trawl Tow Length (mi)</th>' +                
                '<th>Total Catch (MT)</th>' +
                '<th>Flatfish Catch (MT)</th>' +
                '<th>Rockfish Catch (MT)</th>' +
                '<th>Roundfish Catch (MT)</th>' +
                '<th>Sharks & Skates Catch (MT)</th>' +
                '<th>Other Catch (MT)</th>' +
                '<th>Total Ex-Vessel Value</th>' +
                '<th>Flatfish Ex-Vessel Value</th>' +
                '<th>Rockfish Ex-Vessel Value</th>' +
                '<th>Roundfish Ex-Vessel Value</th>' +
                '<th>Sharks & Skates Ex-Vessel Value</th>' +
                '<th>Other Catch Ex-Vessel Value</th>' + 
                '</tr>'

            // loop through all the selected features
            selectedSet.forEach(function (selection) {

                var data = selection.feature.properties;

                // Tow Length filter (< 3 vessels in an area)
                var towLen;
                if (data.VesCount >= 3 || data.VesCount == 0) {
                    towLen = m2mi(data.TowLenM);
                    
                } else {
                    towLen = "**";
                }


                rows += '<tr>' +
                    '<td>' + data.RegAction + '</td>' +
                    '<td>' + data.SiteName + '</td>' +
                    '<td>' + data.Proposer + '</td>' +
                    '<td>' + sqm2sqmi(data.SiteAreaM2) + '</td>' +
                    '<td>' + pct(data.hard, data.SiteAreaM2) + '</td>' +
                    '<td>' + pct(data.mixed, data.SiteAreaM2) + '</td>' +
                    '<td>' + pct(data.soft, data.SiteAreaM2) + '</td>' +
                    '<td>' + pct(data.unknown, data.SiteAreaM2) + '</td>' +
                    '<td>' + pct(data.CynAreaM2, data.SiteAreaM2) + '</td>' +
                    '<td>' + pct(data.SmtAreaM2, data.SiteAreaM2) + '</td>' +
                    '<td>' + data.corspg_cnt + '</td>' +
                    '<td>' + pct(data.OF20AreaM2, data.SiteAreaM2) + '</td>'                
                
                if (data.VesCount >= 3 || data.VesCount == 0) {
                    rows += '<td>' + m2mi(data.TowLenM) + '</td>' +
                    '<td>' + rnd(data.Total_MT, 1) + '</td>' +
                    '<td>' + rnd(data.Flatfish_MT, 1) + '</td>' +
                    '<td>' + rnd(data.Rockfish_MT, 1) + '</td>' +
                    '<td>' + rnd(data.Roundfish_MT, 1) + '</td>' +
                    '<td>' + rnd(data.SharkSkate_MT, 1) + '</td>' +
                    '<td>' + rnd(data.Other_MT, 1) + '</td>' +
                    '<td>' + dollars(data.Total_Rev) + '</td>' +
                    '<td>' + dollars(data.Flatfish_Rev) + '</td>' +
                    '<td>' + dollars(data.Rockfish_Rev) + '</td>' +
                    '<td>' + dollars(data.Roundfish_Rev) + '</td>' +
                    '<td>' + dollars(data.SharkSkate_Rev) + '</td>' +
                    '<td>' + dollars(data.Other_Rev) + '</td>'
                } else {
                    rows += '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>' +
                    '<td>' + '**' + '</td>'
                }
                
                
                rows += '</tr>'
            });


            // update the html of the table
            $table.html(rows);
            
            $('#download-csv').addClass('show');
//            $('#download-csv').css('visibility','visible');


        } // end of updatePolyTable()

        (function () {

            $("#download-csv").click(function () {
                2
                console.log('hi');
                $('#polygon-metrics').tableToCSV();
                3
            });

        })();
        
    </script>

</body>

</html>